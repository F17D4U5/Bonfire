<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bonfire: Core Survival</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #1e293b; color: #f8fafc; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .night-mode { background-color: #1a202c !important; color: #a5b4fc !important; }
        
        /* --- UKURAN PANEL STATS OVERLAY --- */
        .stats-grid-compact { 
            display: flex; 
            gap: 12px; 
            padding: 3px 8px; 
            background-color: rgba(15, 23, 42, 0.85); 
            border-bottom-left-radius: 6px; 
            border-bottom-right-radius: 6px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-box-compact { 
            font-size: 0.75rem; 
            font-weight: bold;
            color: #f8fafc; 
            padding: 3px 0; 
            text-shadow: 0 0 2px #000;
        }
        
        /* ----------------------------------------------------- */
        /* --- KELOMPOK UI KIRI (PEKERJA & BANGUNAN) --- */
        /* ----------------------------------------------------- */
        /* Kontainer untuk menampung kedua panel agar sejajar di kiri */
        #left-ui-container {
            position: absolute;
            top: 50px; 
            left: 4px;
            z-index: 10;
        }

        /* ----------------------------------------------------- */
        /* --- PANEL PEKERJA (Paling Atas) --- */
        /* ----------------------------------------------------- */
        #action-panel-container {
            /* Dikelola oleh #left-ui-container. Dibuat flex untuk menampung tombol dan konten. */
            display: flex;
            align-items: flex-start;
            margin-bottom: 5px; /* Memberi jarak ke tombol bangunan */
        }

        #worker-controls-content {
            transform: translateX(-100%); 
            transition: transform 0.3s ease-in-out;
            margin-left: -4px; 
            padding: 8px; 
            background-color: rgba(45, 62, 80, 0.9); 
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 4px 0 6px rgba(0, 0, 0, 0.2);
        }

        #action-panel-container.open #worker-controls-content {
            transform: translateX(0); 
        }
        
        /* ------------------------------------------------------------------- */
        /* --- PANEL BANGUNAN (Di Bawah Pekerja) ---*/
        /* ------------------------------------------------------------------- */
        #build-panel-container {
             display: flex; /* Memastikan tombol palu dan konten panel sejajar */
             align-items: flex-start;
             position: relative;
        }

        #build-controls-content {
            transform: translateX(-100%); /* Sembunyikan ke kiri */
            transition: transform 0.3s ease-in-out;
            margin-left: -4px; 
            padding: 8px; 
            background-color: rgba(45, 62, 80, 0.9); 
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 4px 0 6px rgba(0, 0, 0, 0.2);
            width: 200px; /* Lebar agar tombol pembangunan muat */
        }
        
        /* Geser panel ke kanan saat terbuka */
        #build-panel-container.open #build-controls-content {
            transform: translateX(0);
        }

        /* UKURAN TOMBOL TOGGLE (Pekerja & Bangunan) */
        .toggle-button {
            padding: 3px 6px; 
            background-color: #3b82f6;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            font-size: 0.8rem; 
            cursor: pointer;
            z-index: 11; 
            transition: background-color 0.2s;
            line-height: 1.25;
        }

        /* Kustomisasi Tombol Toggle Pekerja */
        #action-panel-container.open #toggle-worker-button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        /* Kustomisasi Tombol Toggle Pembangunan (Palau) */
        #build-panel-container.open #toggle-build-button {
             border-top-left-radius: 0;
             border-bottom-left-radius: 0;
        }

        /* UKURAN FONT DI DALAM PANEL KONTROL */
        #worker-controls-content .text-sm, #build-controls-content .text-sm {
            font-size: 0.8rem; 
        }
        
        /* UKURAN TOMBOL +/- */
        #worker-controls-content button {
            width: 1.25rem; 
            height: 1.25rem; 
            font-size: 0.75rem; 
        }
        
        .time-status { font-weight: bold; font-size: 1.25rem; }
        .night-mode { background-color: #1a202c; color: #a5b4fc; }
        .log-error { color: #f87171; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-4">üî• The Bonfire: Core Survival</h1>
        
        <div id="game-status" class="flex justify-between items-center bg-sky-900 p-3 rounded-lg mb-4">
            <span id="time-display" class="time-status"></span>
            <span id="log-display" class="text-sm italic">Selamat datang di pantai tak dikenal.</span>
        </div>

        <div id="canvas-wrapper" class="relative bg-slate-800 p-0 rounded-lg mb-4 flex justify-center">
            
            <canvas id="gameCanvas" width="700" height="300" class="bg-gray-900 border border-gray-600 rounded-md"></canvas>

            <div id="stats-overlay" class="absolute top-0 left-1/2 transform -translate-x-1/2 z-20">
                <div class="stats-grid-compact">
                    <div class="stat-box-compact">ü™µ Kayu: <span id="wood-stat">0</span></div>
                    <div class="stat-box-compact">ü•© Makanan: <span id="food-stat">0</span></div>
                    <div class="stat-box-compact">üë®‚Äçüë©‚Äçüëß Penduduk: <span id="population-stat">1</span></div>
                </div>
            </div>
            
            <div id="left-ui-container">
            
                <div id="action-panel-container">
                    
                    <button id="toggle-worker-button" class="toggle-button" onclick="toggleWorkerPanel()">
                        >>
                    </button>
                    
                    <div id="worker-controls-content" class="bg-slate-700/80 backdrop-blur-sm z-10 shadow-lg hidden">
                        <h2 class="text-base font-semibold mb-2 text-white border-b border-slate-500 pb-1">Alokasi Pekerja</h2>
                        
                        <div class="flex flex-col gap-2">
                            
                            <div class="flex justify-between items-center w-48">
                                <span class="text-sm">ü™µ Kayu: <span id="gatherer-stat-short">0</span></span>
                                <div>
                                    <button onclick="modifyWorker('gatherer', -1)" class="bg-gray-500 hover:bg-gray-600 text-white rounded-l disabled:opacity-50 font-bold">-</button>
                                    <button onclick="modifyWorker('gatherer', 1)" class="bg-green-600 hover:bg-green-700 text-white rounded-r disabled:opacity-50 font-bold">+</button>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-sm">ü•© Hunter: <span id="hunter-stat-short">0</span> / <span id="max-hunter-stat-short">0</span></span>
                                <div>
                                    <button onclick="modifyWorker('hunter', -1)" class="bg-gray-500 hover:bg-gray-600 text-white rounded-l disabled:opacity-50 font-bold">-</button>
                                    <button onclick="modifyWorker('hunter', 1)" class="bg-yellow-600 hover:bg-yellow-700 text-white rounded-r disabled:opacity-50 font-bold">+</button>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-sm">üõ°Ô∏è Penjaga: <span id="guard-stat-short">0</span></span>
                                <div>
                                    <button onclick="modifyWorker('guard', -1)" class="bg-gray-500 hover:bg-gray-600 text-white rounded-l disabled:opacity-50 font-bold">-</button>
                                    <button onclick="modifyWorker('guard', 1)" class="bg-red-600 hover:bg-red-700 text-white rounded-r disabled:opacity-50 font-bold">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <p class="mt-3 text-xs text-white/80 border-t border-slate-500 pt-2">Pekerja Bebas: <span id="free-workers-stat-short">1</span></p>
                    </div>
                </div>
            
                <div id="build-panel-container">
                    
                    <button id="toggle-build-button" class="toggle-button" onclick="toggleBuildPanel()">
                        üî®
                    </button>

                    <div id="build-controls-content" class="bg-slate-700/80 backdrop-blur-sm z-10 shadow-lg hidden">
                        <h2 class="text-base font-semibold mb-2 text-white border-b border-slate-500 pb-1">Pembangunan</h2>
                        <div class="flex flex-col gap-2">
                            <button onclick="buildBuilding('hunterHut')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded disabled:opacity-50 text-sm" id="build-hunterhut-btn">
                                Hunter Hut (20 ü™µ) (<span id="hunterhut-count">0</span>)
                            </button>
                            
                            <button onclick="buildBuilding('storageHut')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded disabled:opacity-50 text-sm" id="build-storagehut-btn">
                                Storage Hut (30 ü™µ) (<span id="storagehut-count">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="bg-yellow-800 p-3 rounded-lg absolute top-4 right-4 z-10 shadow-lg" id="wanderer-panel" style="display: none;">
                <h3 class="text-lg font-semibold mb-2">Seorang Pengembara Tiba!</h3>
                <p class="text-sm mb-3">Orang ini kelaparan dan meminta <span id="wanderer-cost">3</span>ü•© Makanan untuk menetap.</p>
                <div class="flex gap-4">
                    <button onclick="handleWanderer('accept')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50" id="wanderer-accept-btn">
                        Terima & Beri Makan
                    </button>
                    <button onclick="handleWanderer('reject')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="wanderer-reject-btn">
                        Tolak
                    </button>
                </div>
            </div>

        </div>
        
    </div>

    <div id="game-over-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center z-50" style="display: none;">
        <h1 class="text-6xl font-extrabold text-red-600 mb-4 animate-pulse">GAME OVER</h1>
        <p id="game-over-cause" class="text-xl text-white mb-8 text-center px-4">Desa Anda hancur dan tidak ada penduduk yang tersisa.</p>
        <button onclick="restartGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
            Mulai Ulang (Hari 1)
        </button>
    </div>

    <script>
// --- DEKLARASI STATE GAME ---
const initialGameState = {
    population: 1, freeWorkers: 1, maxWorkers: 1, 
    resources: { wood: 100, food: 50, }, 
    storage: { woodMax: 100, foodMax: 100, baseCapacity: 100, capacityPerHut: 100, },
    time: { dayCount: 1, hour: 8, isNight: false, isAttackPhase: false, },
    workers: { gatherer: 0, guard: 0, hunter: 0, },
    buildings: { 
        hunterHut: { count: 0, workers: 0, cost: { wood: 20 }, maxWorkers: 1, }, 
        storageHut: { count: 0, workers: 0, cost: { wood: 30 }, maxWorkers: 0, }, 
    },
    defense: { raidStrength: 0, },
    events: { isWandererPresent: false, wandererFoodCost: 3, wandererArrivalHour: 0, },
    bonfire: { woodCostPerCycle: 1, isBurning: true, },
    isGameOver: false, 
};

let gameState = JSON.parse(JSON.stringify(initialGameState));

// Variabel DOM
const timeDisplay = document.getElementById('time-display');
const logDisplay = document.getElementById('log-display');
const container = document.querySelector('.container');

// Panel Pekerja
const actionPanelContainer = document.getElementById('action-panel-container');
const workerControlsContent = document.getElementById('worker-controls-content');
const toggleWorkerButton = document.getElementById('toggle-worker-button');

// Panel Pembangunan BARU
const buildPanelContainer = document.getElementById('build-panel-container');
const buildControlsContent = document.getElementById('build-controls-content');
const toggleBuildButton = document.getElementById('toggle-build-button');


let canvas;
let ctx;
let animationFrameId; 
let BONFIRE_POS;
let WORKER_START_Y;
let timeIntervalId;
let cityIntervalId;

// Konstanta
const TILE_SIZE = 50; 
const WORKER_COLORS = { 
    gatherer: '#10b981', 
    hunter: '#3b82f6', 
    guard: '#ef4444', 
    freeWorker: '#facc15', 
    raider: '#4b5563', 
};

// --- VARIABEL BARU UNTUK GERAK ACAK PEKERJA ---
let visualWorkers = [];
const REST_RADIUS = 30; 
const MIN_DISTANCE_FROM_BONFIRE = 15; 
const TRANSITION_SPEED = 6.0; 

/* -------------- FUNGSI TOGGLE PANEL -------------- */

function toggleWorkerPanel() {
    const isOpen = actionPanelContainer.classList.toggle('open');
    workerControlsContent.classList.toggle('hidden', !isOpen);
    toggleWorkerButton.textContent = isOpen ? '<<' : '>>';
    
    // Logika pembulatan tombol toggle pekerja
    if (isOpen) {
        toggleWorkerButton.classList.remove('rounded-full');
        toggleWorkerButton.classList.add('rounded-tr-none', 'rounded-br-none');
    } else {
        toggleWorkerButton.classList.remove('rounded-tr-none', 'rounded-br-none');
        toggleWorkerButton.classList.add('rounded-full'); 
    }
}

function toggleBuildPanel() {
    const isOpen = buildPanelContainer.classList.toggle('open');
    buildControlsContent.classList.toggle('hidden', !isOpen);
    toggleBuildButton.textContent = isOpen ? 'X' : 'üî®'; // Ubah ikon saat terbuka

    // Logika pembulatan tombol toggle bangunan
    if (isOpen) {
        toggleBuildButton.classList.remove('rounded-full');
        toggleBuildButton.classList.add('rounded-tr-none', 'rounded-br-none');
    } else {
        toggleBuildButton.classList.remove('rounded-tr-none', 'rounded-br-none');
        toggleBuildButton.classList.add('rounded-full');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Inisialisasi awal panel Pekerja
    if (!actionPanelContainer.classList.contains('open')) {
        toggleWorkerButton.classList.add('rounded-full');
        workerControlsContent.classList.add('hidden'); 
    }
    // Inisialisasi awal panel Bangunan
    if (!buildPanelContainer.classList.contains('open')) {
        toggleBuildButton.classList.add('rounded-full');
        buildControlsContent.classList.add('hidden'); 
    }
});

/* -------------- HELPER & GAME OVER -------------- */
function gameLog(message, isError = false) {
    logDisplay.textContent = message;
    logDisplay.classList.toggle('log-error', isError);
}

function interpolateColor(color1, color2, factor) {
    if (factor < 0) factor = 0;
    if (factor > 1) factor = 1;
    
    const hexToRgb = (hex) => [
        parseInt(hex.substring(1, 3), 16),
        parseInt(hex.substring(3, 5), 16),
        parseInt(hex.substring(5, 7), 16),
    ];
    
    const rgb1 = hexToRgb(color1);
    const rgb2 = hexToRgb(color2);
    
    const r = Math.round(rgb1[0] + (rgb2[0] - rgb1[0]) * factor);
    const g = Math.round(rgb1[1] + (rgb2[1] - rgb1[1]) * factor);
    const b = Math.round(rgb1[2] + (rgb2[2] - rgb1[2]) * factor);
    
    return `rgb(${r}, ${g}, ${b})`;
}

function endGame(cause) {
    if (gameState.isGameOver) return; 

    gameState.isGameOver = true;
    
    clearInterval(timeIntervalId);
    clearInterval(cityIntervalId);
    cancelAnimationFrame(animationFrameId);

    const gameOverOverlay = document.getElementById('game-over-overlay');
    const causeMessage = document.getElementById('game-over-cause');
    
    if (cause === "kelaparan") {
        causeMessage.textContent = "Kekalahan! Semua penduduk tewas kelaparan. Kelola makanan dengan lebih baik.";
    } else if (cause === "serangan") {
        causeMessage.textContent = "Kekalahan! Desa hancur dan penduduk musnah setelah serangan yang brutal.";
    } else {
        causeMessage.textContent = "GAME OVER: Semua penduduk hilang.";
    }
    
    gameOverOverlay.style.display = 'flex';
    gameLog("!!! GAME OVER !!!", true);
}

function restartGame() {
    clearInterval(timeIntervalId);
    clearInterval(cityIntervalId);
    
    gameState = JSON.parse(JSON.stringify(initialGameState));
    visualWorkers = []; 
    
    document.getElementById('game-over-overlay').style.display = 'none';
    
    container.classList.remove('night-mode');
    
    actionPanelContainer.classList.remove('open');
    workerControlsContent.classList.add('hidden');
    toggleWorkerButton.textContent = '>>';
    toggleWorkerButton.classList.add('rounded-full');
    
    buildPanelContainer.classList.remove('open');
    buildControlsContent.classList.add('hidden');
    toggleBuildButton.textContent = 'üî®';
    toggleBuildButton.classList.add('rounded-full');
    
    init(); 
    gameLog("Game diulang! Selamat datang kembali, Survivor.");
}

/* -------------- A. MEKANIK WAKTU & SIKLUS -------------- */
function updateTime() {
    if (gameState.isGameOver) return; 
    
    gameState.time.hour++;

    if (gameState.time.hour >= 24) {
        gameState.time.hour = 0;
        gameState.time.dayCount++;
        gameLog(`Hari ${gameState.time.dayCount} telah tiba!`);
        
        if (gameState.time.dayCount % 5 === 0) {
             gameState.population++;
             gameState.freeWorkers++;
             gameState.maxWorkers++;
             gameLog(`Wanderer baru bergabung! Populasi: ${gameState.population}`);
             syncVisualWorkers(); 
        }
    }

    const wasNight = gameState.time.isNight;
    const wasAttackPhase = gameState.time.isAttackPhase;
    const currentHour = gameState.time.hour;
    
    // Logika Pengembara (Jam 7 sampai jam 17)
    if (!gameState.time.isNight && !gameState.events.isWandererPresent && gameState.time.dayCount > 1) {
        if (currentHour >= 7 && currentHour <= 12) {
            if (Math.random() < 0.10) { 
                gameState.events.isWandererPresent = true;
                gameState.events.wandererArrivalHour = currentHour;
                gameLog(`üëã Seorang Pengembara tiba! Klik tombol 'Terima Pengembara' di kanan atas.`);
            }
        }
    }
    if (gameState.events.isWandererPresent && currentHour === 17) {
        gameLog(`Pengembara itu pergi karena Anda tidak menawarkan makanan.`, true);
        gameState.events.isWandererPresent = false;
    }
    
    // --- LOGIKA UTAMA SIKLUS SIANG/MALAM ---

    // Transisi ke Malam (Jam 18:00)
    if (currentHour === 18 && !wasNight) {
        gameState.time.isNight = true; 
        gameLog("üîî Matahari terbenam! Persiapkan penjaga Anda!");
        container.classList.add('night-mode');
        
        // Pergerakan pekerja ke area istirahat
        const REST_CENTER_Y = BONFIRE_POS.y + 40;
        visualWorkers.forEach(worker => {
            if (worker.type === 'gatherer' || worker.type === 'hunter') {
                worker.targetX = BONFIRE_POS.x + (Math.random() * 20 - 10); 
                worker.targetY = REST_CENTER_Y + (Math.random() * 20 - 10);
                worker.isTargetedMoving = true;
            }
        });
    }

    // Transisi ke FASE SERANGAN (Jam 22:00) - Tetap
    if (currentHour === 22 && !wasAttackPhase) {
        gameState.time.isAttackPhase = true;
        gameState.defense.raidStrength = gameState.time.dayCount * 2 + Math.floor(Math.random() * 5); 
        
        gameLog(`Musuh mendekat! Kekuatan serangan: ${gameState.defense.raidStrength}.`);
        handleNightRaid();
    }
    
    // Transisi ke Siang (Jam 05:00)
    if (currentHour === 5 && wasNight) {
        gameState.time.isNight = false;
        gameState.time.isAttackPhase = false; 
        
        gameState.defense.raidStrength = 0;
        
        gameLog("Selamat pagi! Saatnya bekerja kembali.");
        container.classList.remove('night-mode');
        
        // Pergerakan pekerja ke tempat kerja
        const WORK_SPOT_X = 50;
        const WORK_SPOT_Y = BONFIRE_POS.y;
        
        // Hitung ulang posisi kerja untuk semua pekerja non-penjaga
        const currentGatherers = visualWorkers.filter(w => w.type === 'gatherer');
        const currentHunters = visualWorkers.filter(w => w.type === 'hunter');

        visualWorkers.forEach((worker) => {
            if (worker.type === 'gatherer' || worker.type === 'hunter') {
                // HANYA pindahkan jika pekerja tidak dalam transisi (sudah di area istirahat)
                // Ini juga mencakup pekerja yang di-set pada malam hari dan belum bergerak
                if (!worker.isTargetedMoving) { 
                    const isGatherer = worker.type === 'gatherer';
                    const offset = isGatherer ? 0 : 30;
                    
                    // Dapatkan indeks pekerja di antara rekan sejenisnya
                    const index = isGatherer ? currentGatherers.indexOf(worker) : currentHunters.indexOf(worker);
                    
                    worker.targetX = WORK_SPOT_X + (Math.random() * 10 - 5);
                    worker.targetY = WORK_SPOT_Y + offset + (index * 15) + (Math.random() * 10 - 5);
                    worker.isTargetedMoving = true;
                }
            }
        });
    }
    
    updateUI();
}

/* -------------- B. MEKANIK UTAMA GAME -------------- */
function updateCity() {
    if (gameState.isGameOver) return;
    
    const storageHutCount = gameState.buildings.storageHut.count;
    const bonusStorage = storageHutCount * gameState.storage.capacityPerHut;
    
    gameState.storage.woodMax = gameState.storage.baseCapacity + bonusStorage;
    gameState.storage.foodMax = gameState.storage.baseCapacity + bonusStorage;

    // 2. PENGUMPULAN SUMBER DAYA
    let woodGained = 0;
    let foodProduced = 0;
    
    if (!gameState.time.isNight) {
        woodGained = gameState.workers.gatherer * 3;
        foodProduced = gameState.workers.hunter * 5; 
    }
    
    gameState.resources.wood += woodGained;
    gameState.resources.food += foodProduced; 
    
    gameState.resources.wood = Math.min(gameState.resources.wood, gameState.storage.woodMax);
    gameState.resources.food = Math.min(gameState.resources.food, gameState.storage.foodMax);
    
    // 3. KONSUMSI MAKANAN
    gameState.resources.food -= gameState.population * 1; 

    // 4. LOGIKA BONFIRE: Konsumsi Kayu
    const cost = gameState.bonfire.woodCostPerCycle; 
    
    if (gameState.resources.wood >= cost) {
        gameState.resources.wood -= cost;
        gameState.bonfire.isBurning = true;
    } else {
        gameState.bonfire.isBurning = false;
        
        if (gameState.freeWorkers > 0) {
            gameState.freeWorkers = Math.max(0, gameState.freeWorkers - 1);
            gameLog(`üî• API PADAM! Kita kehilangan semangat. 1 Pekerja menjadi tidak efisien.`, true);
        } else {
            gameLog(`üî• API PADAM! Segera kumpulkan kayu!`, true);
        }
    }

    // 5. SURVIVAL CHECK: Kelaparan (Bisa menyebabkan Game Over)
    if (gameState.resources.food < 0) {
        gameState.resources.food = 0;
        if (Math.random() < 0.05 && gameState.population > 0) { 
            gameState.population = gameState.population - 1; 
            gameState.maxWorkers = gameState.population;
            gameState.freeWorkers = Math.max(0, gameState.freeWorkers - 1); 
            gameLog("Penduduk meninggal karena kelaparan! Kelola makanan dengan baik.", true);
        }
    }
    
    // 6. GAME OVER CHECK
    if (gameState.population <= 0) {
        endGame("kelaparan");
    }

    updateUI();
}

/* -------------- C. MEKANIK PERTAHANAN MALAM -------------- */
function handleNightRaid() {
    const attack = gameState.defense.raidStrength;
    
    let defensePower = gameState.workers.guard * 5; 
    if (!gameState.bonfire.isBurning) {
        defensePower = Math.floor(defensePower / 2); 
        gameLog(`Api padam! Pertahanan melemah menjadi ${defensePower}.`, true);
    }
    
    if (attack === 0) return; 

    if (defensePower >= attack) {
        gameState.resources.wood += 5;
        gameLog(`üéâ Kemenangan! Penjaga berhasil mengusir mereka dan mengamankan 5 Kayu tambahan!`);
    } else {
        const damageTaken = attack - defensePower;
        gameState.resources.wood = Math.max(0, gameState.resources.wood - damageTaken * 3);
        
        if (damageTaken > 10 && gameState.population > 0) { 
            gameState.population = gameState.population - 1; 
            gameState.maxWorkers = gameState.population;
            
            if (gameState.workers.guard > 0) {
                gameState.workers.guard = Math.max(0, gameState.workers.guard - 1);
                gameLog(`üíÄ SERANGAN GAGAL TOTAL! Kita kehilangan 1 penduduk (Penjaga) dan Kayu akibat serangan sebesar ${damageTaken}.`, true);
            } else {
                 gameState.freeWorkers = Math.max(0, gameState.freeWorkers - 1); 
                 gameLog(`üíÄ SERANGAN GAGAL TOTAL! Kita kehilangan 1 penduduk dan Kayu akibat serangan sebesar ${damageTaken}.`, true);
            }

        } else {
            gameLog(`Serangan berhasil dipukul mundur, tapi kita kehilangan Kayu. Kerugian: ${damageTaken}.`);
        }
    }
    
    if (gameState.population <= 0) {
        endGame("serangan");
        return; 
    }
    
    gameState.defense.raidStrength = 0; 
    updateUI();
}

/* -------------- D. LOGIKA PEKERJA & BANGUNAN -------------- */
function modifyWorker(type, change) {
    if (gameState.isGameOver) return; 
    
    const WORKER_TYPE = type;
    
    if (change > 0) {
        if (gameState.freeWorkers <= 0) {
            gameLog("Tidak ada pekerja bebas yang tersisa!", true);
            return;
        }

        if (WORKER_TYPE === 'hunter') {
            const maxHunters = gameState.buildings.hunterHut.count * gameState.buildings.hunterHut.maxWorkers;
            if (gameState.workers.hunter >= maxHunters) {
                gameLog(`Anda perlu membangun Hunter's Hut (Pemburu) lagi! Kapasitas: ${maxHunters}.`, true);
                return;
            }
        }
        
        // Transisi saat mengambil pekerjaan (Harus terjadi sebelum syncVisualWorkers)
        const workerToTransition = visualWorkers.find(w => w.type === 'freeWorker');

        if (workerToTransition) {
             
             // *** PERBAIKAN LOGIKA PEKERJA MALAM & PENJAGA ***
             if (WORKER_TYPE === 'guard') {
                 // Penjaga tidak perlu transisi ke target X/Y. Logika rotasi langsung mengambil alih.
                 workerToTransition.isTargetedMoving = false; 
                 workerToTransition.targetX = null;
                 workerToTransition.targetY = null;

             } else if (gameState.time.isNight) {
                 // Pekerja Siang (Penebang/Pemburu) yang ditetapkan saat MALAM
                 // Mereka tidak bergerak ke tempat kerja, tapi tetap di area istirahat.
                 // Akan bergerak saat pagi tiba di updateTime.
                 workerToTransition.isTargetedMoving = false; 
                 workerToTransition.targetX = null;
                 workerToTransition.targetY = null;
                 gameLog(`Pekerja ditetapkan sebagai ${WORKER_TYPE}. Akan mulai bekerja saat fajar tiba.`);

             } else {
                 // Pekerja Siang (Penebang/Pemburu) yang ditetapkan saat SIANG
                 workerToTransition.isTargetedMoving = true; 
                 const WORK_SPOT_X = 50;
                 const WORK_SPOT_Y = BONFIRE_POS.y;
                 const isGatherer = WORKER_TYPE === 'gatherer';
                 const offset = isGatherer ? 0 : 30;
                 const indexBaru = gameState.workers[WORKER_TYPE]; 
                 
                 workerToTransition.targetX = WORK_SPOT_X + (Math.random() * 10 - 5);
                 workerToTransition.targetY = WORK_SPOT_Y + offset + (indexBaru * 15) + (Math.random() * 10 - 5);
             }
        }
        
        gameState.workers[WORKER_TYPE]++;
        gameState.freeWorkers--;
    } 
    else if (change < 0) {
        if (gameState.workers[WORKER_TYPE] <= 0) {
            gameLog(`Tidak ada ${WORKER_TYPE} yang bisa dibebaskan.`);
            return;
        }

        gameState.workers[WORKER_TYPE]--;
        gameState.freeWorkers++;
        
        // Transisi saat dibebaskan menjadi freeWorker
        const workerToTransition = visualWorkers.find(w => w.type === WORKER_TYPE);
        if (workerToTransition) {
            workerToTransition.isTargetedMoving = true;
            // Arahkan ke area istirahat
            const REST_CENTER_Y = BONFIRE_POS.y + 40;
            workerToTransition.targetX = BONFIRE_POS.x + (Math.random() * 20 - 10); 
            workerToTransition.targetY = REST_CENTER_Y + (Math.random() * 20 - 10);
        }
    }
    
    syncVisualWorkers();
    updateUI();
}

function buildBuilding(type) {
    if (gameState.isGameOver) return; 
    const building = gameState.buildings[type];
    const cost = building.cost;

    if (gameState.resources.wood >= cost.wood) {
        gameState.resources.wood -= cost.wood;
        building.count++;
        gameLog(`Berhasil membangun ${type}! Biaya: ${cost.wood} Kayu.`);
    } else {
        gameLog(`Tidak cukup sumber daya untuk membangun ${type}! Butuh ${cost.wood} Kayu.`, true);
    }
    
    updateUI();
}

function handleWanderer(action) {
    if (gameState.isGameOver) return; 
    if (!gameState.events.isWandererPresent) return;

    const foodCost = gameState.events.wandererFoodCost;

    if (action === 'accept') {
        if (gameState.resources.food >= foodCost) {
            gameState.resources.food -= foodCost;
            gameState.population++;
            gameState.freeWorkers++;
            gameState.maxWorkers++;
            
            syncVisualWorkers(); 
            
            gameLog(`üëè Anda menerima Pengembara! Populasi bertambah menjadi ${gameState.population}. Makanan berkurang: ${foodCost}.`);
        } else {
            gameLog(`Makanan tidak cukup (${foodCost}ü•©)! Pengembara masih menunggu, tapi akan pergi pada jam 17:00.`, true);
            return; 
        }
    } else if (action === 'reject') {
        gameLog(`Anda menolak Pengembara. Mereka pergi mencari tempat lain.`);
    }

    gameState.events.isWandererPresent = false;
    updateUI();
}

/* -------------- F. UPDATE UI & CANVAS -------------- */
function updateUI() {
    const currentHour = gameState.time.hour.toString().padStart(2, '0');
    const timeStatus = gameState.time.isNight ? 'üî¥ Malam' : '‚òÄÔ∏è Siang';
    timeDisplay.textContent = `${timeStatus} | Hari ${gameState.time.dayCount} (${currentHour}:00)`;
    
    // Update Stat Overlay
    document.getElementById('wood-stat').textContent = `${gameState.resources.wood} / ${gameState.storage.woodMax}`;
    document.getElementById('food-stat').textContent = `${gameState.resources.food} / ${gameState.storage.foodMax}`;
    document.getElementById('population-stat').textContent = gameState.population;
    
    // Update Worker Panel
    document.getElementById('free-workers-stat-short').textContent = gameState.freeWorkers;
    document.getElementById('gatherer-stat-short').textContent = gameState.workers.gatherer;
    document.getElementById('guard-stat-short').textContent = gameState.workers.guard;
    document.getElementById('hunter-stat-short').textContent = gameState.workers.hunter;

    const maxHunters = gameState.buildings.hunterHut.count * gameState.buildings.hunterHut.maxWorkers;
    document.getElementById('max-hunter-stat-short').textContent = maxHunters;

    // Update Building Buttons 
    const hunterHutCost = gameState.buildings.hunterHut.cost.wood;
    document.getElementById('build-hunterhut-btn').disabled = gameState.resources.wood < hunterHutCost;
    document.getElementById('hunterhut-count').textContent = gameState.buildings.hunterHut.count;

    const storageHutCost = gameState.buildings.storageHut.cost.wood;
    document.getElementById('build-storagehut-btn').disabled = gameState.resources.wood < storageHutCost;
    document.getElementById('storagehut-count').textContent = gameState.buildings.storageHut.count;

    // Update Wanderer Panel
    const wandererPanel = document.getElementById('wanderer-panel');
    const wandererCostDisplay = document.getElementById('wanderer-cost');
    const wandererAcceptBtn = document.getElementById('wanderer-accept-btn');
    
    if (gameState.events.isWandererPresent) {
        wandererPanel.style.display = 'block';
        wandererCostDisplay.textContent = gameState.events.wandererFoodCost;
        wandererAcceptBtn.disabled = gameState.resources.food < gameState.events.wandererFoodCost;
    } else {
        wandererPanel.style.display = 'none';
    }
}


function drawBonfire(time) {
    if (!BONFIRE_POS) return; 
    if (!gameState.bonfire.isBurning) {
        ctx.fillStyle = '#334155';
        ctx.beginPath();
        ctx.arc(BONFIRE_POS.x, BONFIRE_POS.y, 8, 0, Math.PI * 2); 
        ctx.fill();
        return; 
    }
    const colorIntensity = Math.sin(time / 150) * 0.1 + 0.9;
    const red = Math.floor(255 * colorIntensity);
    const orange = Math.floor(165 * colorIntensity);
    ctx.fillStyle = time % 400 < 200 ? `rgb(${red}, 68, 68)` : `rgb(${red}, ${orange}, 68)`;
    ctx.beginPath();
    ctx.arc(BONFIRE_POS.x, BONFIRE_POS.y, 10, 0, Math.PI * 2); 
    ctx.fill();
    ctx.fillStyle = 'rgba(255, 100, 0, 0.1)';
    ctx.beginPath();
    ctx.arc(BONFIRE_POS.x, BONFIRE_POS.y, 20 + Math.sin(time / 200) * 5, 0, Math.PI * 2);
    ctx.fill();
}

function drawBuildings() {
    if (!BONFIRE_POS) return; 
    
    // Hunter Hut
    const hutCount = gameState.buildings.hunterHut.count;
    const HUT_WIDTH = 50;
    const HUT_HEIGHT = 30;
    const ROOF_HEIGHT = 20;
    
    for (let i = 0; i < hutCount; i++) {
        const x = BONFIRE_POS.x + 80 + (i * (HUT_WIDTH + 20)); // Tambah jarak antar pondok
        const y = BONFIRE_POS.y - 20; // Posisi dasar bangunan

        // 1. Atap
        ctx.fillStyle = '#8B4513'; // Coklat tua untuk atap
        ctx.beginPath();
        // Atap dimulai dari titik y yang sama dengan bagian atas tiang/dinding
        ctx.moveTo(x - 5, y); 
        ctx.lineTo(x + HUT_WIDTH + 5, y); 
        ctx.lineTo(x + HUT_WIDTH / 2, y - ROOF_HEIGHT); // Puncak atap
        ctx.closePath();
        ctx.fill();

        // 2. Dinding Belakang (terlihat di dalam rongga)
        ctx.fillStyle = '#654321'; // Lebih gelap dari kayu dinding
        ctx.fillRect(x + 5, y, HUT_WIDTH - 10, HUT_HEIGHT); 

        // 3. Gantungan Daging (horizontal bars)
        ctx.strokeStyle = '#a9a9a9'; // Abu-abu metalik
        ctx.lineWidth = 2;
        for (let j = 0; j < 3; j++) { // 3 baris gantungan
            const barY = y + 5 + (j * 8);
            ctx.beginPath();
            ctx.moveTo(x + 7, barY);
            ctx.lineTo(x + HUT_WIDTH - 7, barY);
            ctx.stroke();
        }

        // 4. Tiang Penyangga Depan
        ctx.fillStyle = '#A0522D'; // Coklat kayu
        // Tiang kiri. Dimulai dari y yang sama dengan atap dan turun.
        ctx.fillRect(x + 2, y, 5, HUT_HEIGHT + 5); 
        // Tiang kanan. Dimulai dari y yang sama dengan atap dan turun.
        ctx.fillRect(x + HUT_WIDTH - 7, y, 5, HUT_HEIGHT + 5); 
    }
    
    // Storage Hut 
    const storageCount = gameState.buildings.storageHut.count;
    const STORAGE_HUT_WIDTH = TILE_SIZE * 1.2; // 60
    const STORAGE_HUT_HEIGHT = 40;
    const STORAGE_ROOF_OVERHANG = 5; // Untuk atap yang sedikit lebih lebar

    for (let i = 0; i < storageCount; i++) {
        const x = BONFIRE_POS.x - 80 - STORAGE_HUT_WIDTH - (i * (STORAGE_HUT_WIDTH + 20)); 
        const y = BONFIRE_POS.y - 20; // Posisi dasar bangunan

        // Dinding
        ctx.fillStyle = '#78716c'; // Abu-abu tua
        ctx.fillRect(x, y, STORAGE_HUT_WIDTH, STORAGE_HUT_HEIGHT);

        // Atap
        ctx.fillStyle = '#57534e'; // Abu-abu lebih gelap
        ctx.fillRect(x - STORAGE_ROOF_OVERHANG / 2, y - 10, STORAGE_HUT_WIDTH + STORAGE_ROOF_OVERHANG, 10);
        
        // Pintu
        const doorWidth = 15;
        const doorHeight = 25;
        const doorX = x + (STORAGE_HUT_WIDTH / 2) - (doorWidth / 2);
        const doorY = y + STORAGE_HUT_HEIGHT - doorHeight;
        ctx.fillStyle = '#402a1e'; // Coklat gelap untuk pintu
        ctx.fillRect(doorX, doorY, doorWidth, doorHeight);

        // Jendela
        const windowWidth = 8;
        const windowHeight = 8;
        const windowX = x + 10; // Posisi di sebelah kiri
        const windowY = y + 10; // Posisi di atas
        ctx.fillStyle = '#2d333f'; // Sangat gelap untuk kesan kedalaman
        ctx.fillRect(windowX, windowY, windowWidth, windowHeight);
    }
}

// --- FUNGSI SINKRONISASI VISUAL PEKERJA ---
function syncVisualWorkers() {
    const requiredCount = gameState.population;
    
    if (visualWorkers.length !== requiredCount) {
        while (visualWorkers.length < requiredCount) {
            const randomAngle = Math.random() * Math.PI * 2;
            const randomRadius = Math.random() * REST_RADIUS;
            visualWorkers.push({
                x: BONFIRE_POS.x + Math.cos(randomAngle) * randomRadius,
                y: WORKER_START_Y + Math.sin(randomAngle) * randomRadius,
                targetX: null, 
                targetY: null,
                isMoving: true, 
                isTargetedMoving: false, 
                type: 'freeWorker' 
            });
        }
        while (visualWorkers.length > requiredCount) {
            visualWorkers.pop(); 
        }
    }

    let currentIndex = 0;
    
    const workerCounts = { 
        gatherer: gameState.workers.gatherer, 
        hunter: gameState.workers.hunter, 
        guard: gameState.workers.guard, 
        freeWorker: gameState.freeWorkers 
    };
    
    ['gatherer', 'hunter', 'guard', 'freeWorker'].forEach(type => {
        for (let i = 0; i < workerCounts[type]; i++) {
            if (visualWorkers[currentIndex]) {
                // Jangan ubah tipe pekerja yang sedang dalam transisi
                if (!visualWorkers[currentIndex].isTargetedMoving) {
                    visualWorkers[currentIndex].type = type;
                }
            }
            currentIndex++;
        }
    });
}

// --- FUNGSI GERAK ACAK (STOCHASTIC MOVEMENT) ---
function moveWorkerStochastic(worker, center, radius, minDistance) {
    const SPEED = 0.5; 
    const STOP_CHANCE = 0.003; 

    if (Math.random() < STOP_CHANCE) {
        worker.isMoving = !worker.isMoving;
        if (!worker.isMoving) {
            worker.targetX = null;
            worker.targetY = null;
            return; 
        }
    }
    
    if (!worker.isMoving) return; 

    const distToTarget = worker.targetX !== null ? Math.sqrt(Math.pow(worker.x - worker.targetX, 2) + Math.pow(worker.y - worker.targetY, 2)) : 0;
    
    if (worker.targetX === null || distToTarget < 2) {
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * radius;
        
        worker.targetX = center.x + Math.cos(angle) * dist;
        worker.targetY = center.y + Math.sin(angle) * dist;
    }

    const dx = worker.targetX - worker.x;
    const dy = worker.targetY - worker.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist > 0) {
        worker.x += (dx / dist) * SPEED;
        worker.y += (dy / dist) * SPEED;
    }

    const currentDistFromBonfire = Math.sqrt(Math.pow(worker.x - BONFIRE_POS.x, 2) + Math.pow(worker.y - BONFIRE_POS.y, 2));
    if (currentDistFromBonfire < minDistance) {
        const angle = Math.atan2(worker.y - BONFIRE_POS.y, worker.x - BONFIRE_POS.x);
        worker.x = BONFIRE_POS.x + Math.cos(angle) * minDistance;
        worker.y = BONFIRE_POS.y + Math.sin(angle) * minDistance;
        worker.targetX = null;
    }
}

// --- FUNGSI GERAK CEPAT MENUJU TARGET (TRANSISI) ---
function moveWorkerToTarget(worker, speed) {
    if (worker.targetX === null || worker.targetY === null) {
        worker.isTargetedMoving = false; 
        return; 
    }
    
    const dx = worker.targetX - worker.x;
    const dy = worker.targetY - worker.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist > speed) {
        worker.x += (dx / dist) * speed;
        worker.y += (dy / dist) * speed;
    } else {
        worker.x = worker.targetX;
        worker.y = worker.targetY;
        worker.isTargetedMoving = false; 
        worker.targetX = null; 
        worker.targetY = null;
    }
}


function drawWorkers(time) {
    if (!BONFIRE_POS) return; 
    
    syncVisualWorkers(); 

    function drawDot(x, y, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
    }
    
    const REST_CENTER = { x: BONFIRE_POS.x, y: WORKER_START_Y };
    const WORK_SPOT = { x: 50, y: BONFIRE_POS.y };
    const GUARD_RADIUS = 50;

    // Hitung ulang index berdasarkan tipe saat ini (bukan dari visualWorkers index)
    const currentGatherers = visualWorkers.filter(w => w.type === 'gatherer');
    const currentHunters = visualWorkers.filter(w => w.type === 'hunter');

    visualWorkers.forEach((worker) => {
        let x = worker.x;
        let y = worker.y;
        let color = WORKER_COLORS[worker.type] || '#fff'; 
        
        const isProductionWorker = worker.type === 'gatherer' || worker.type === 'hunter';
        
        if (worker.isTargetedMoving) {
            // Pekerja sedang bergerak ke target (tempat kerja/istirahat)
            moveWorkerToTarget(worker, TRANSITION_SPEED);
            x = worker.x;
            y = worker.y;
            
        } else if (worker.type === 'guard') {
            // Logika Gerak Penjaga (Rotasi) - Penjaga selalu aktif
            const guardIndex = visualWorkers.filter(w => w.type === 'guard').indexOf(worker);
            const angle = guardIndex * (Math.PI * 2 / Math.max(1, gameState.workers.guard)) + time / 300;
            x = BONFIRE_POS.x + Math.cos(angle) * GUARD_RADIUS;
            y = BONFIRE_POS.y + Math.sin(angle) * GUARD_RADIUS;
            worker.x = x;
            worker.y = y;

        } else if (isProductionWorker && gameState.time.isNight || worker.type === 'freeWorker') {
            // Logika Istirahat (Malam atau Pekerja Bebas)
            moveWorkerStochastic(worker, REST_CENTER, REST_RADIUS, MIN_DISTANCE_FROM_BONFIRE);
            x = worker.x;
            y = worker.y;
            
        } else if (isProductionWorker && !gameState.time.isNight) {
            // Logika Bekerja (Siang) - Hanya jika tidak dalam transisi
            const offset = worker.type === 'gatherer' ? 0 : 30; 
            const xOffset = Math.sin(time / (200 + visualWorkers.indexOf(worker) * 50)) * 20;
            const yOffset = Math.cos(time / (150 + visualWorkers.indexOf(worker) * 40)) * 10;
            const index = worker.type === 'gatherer' ? currentGatherers.indexOf(worker) : currentHunters.indexOf(worker);
            
            x = WORK_SPOT.x + xOffset;
            y = WORK_SPOT.y + offset + (index * 15) + yOffset;
            
            worker.x = x;
            worker.y = y;
        }

        drawDot(x, y, color);
    });
    
    // Penyerang (Raider)
    if (gameState.time.isAttackPhase && gameState.defense.raidStrength > 0) {
        const raiderCount = gameState.defense.raidStrength; 
        for (let i = 0; i < raiderCount; i++) {
             const x = canvas.width - 50 + Math.sin(time / (100 + i * 30)) * 20; 
             const y = WORKER_START_Y + (i * 10) + Math.cos(time / 120) * 5; 
             drawDot(x, y, WORKER_COLORS['raider']);
        }
    }
}

const DAY_COLOR = '#65a30d'; 
const NIGHT_COLOR = '#0f172a'; 

function drawVillage(time) {
    if (gameState.isGameOver) return; 
    let currentColor = DAY_COLOR;
    const hour = gameState.time.hour;
    let transitionFactor = 0;
    
    const SUNRISE_START = 4; // Fajar dimulai Jam 4
    const SUNRISE_END = 6;   // Siang penuh Jam 6
    const SUNSET_START = 16; // Siang berakhir Jam 16
    const SUNSET_END = 18;   // Malam penuh Jam 18
    const TRANSITION_DURATION = 2; // jam

    // Logika Pewarnaan Kanvas (Berbasis Jam)
    if (hour >= SUNSET_START && hour < SUNSET_END) {
        // Senja: Siang ke Malam (16:00 - 18:00)
        transitionFactor = (hour - SUNSET_START) / TRANSITION_DURATION;
        currentColor = interpolateColor(DAY_COLOR, NIGHT_COLOR, transitionFactor);
    } 
    else if (hour >= SUNSET_END || hour < SUNRISE_START) {
        // Malam Penuh (18:00 - 04:00)
        currentColor = NIGHT_COLOR;
    } 
    else if (hour >= SUNRISE_START && hour < SUNRISE_END) {
        // Fajar: Malam ke Siang (04:00 - 06:00)
        transitionFactor = (hour - SUNRISE_START) / TRANSITION_DURATION;
        currentColor = interpolateColor(NIGHT_COLOR, DAY_COLOR, transitionFactor);
    }
    else {
        // Siang Penuh (06:00 - 16:00)
        currentColor = DAY_COLOR;
    }

    ctx.fillStyle = currentColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    drawBuildings(); 
    drawBonfire(time); 
    drawWorkers(time); 

    animationFrameId = requestAnimationFrame(drawVillage);
}


function init() {
    canvas = document.getElementById('gameCanvas');
    
    if (canvas) {
        ctx = canvas.getContext('2d');
        
        BONFIRE_POS = { x: canvas.width / 2, y: canvas.height / 2 + 50 }; 
        WORKER_START_Y = BONFIRE_POS.y + 40;
        
        if (!gameState.isGameOver) {
            animationFrameId = requestAnimationFrame(drawVillage);
        }
    }
    
    if (!gameState.isGameOver) {
        // Kecepatan Waktu: 5000ms (5 detik per jam)
        timeIntervalId = setInterval(updateTime, 5000); 
        cityIntervalId = setInterval(updateCity, 5000); 
    }
    
    updateUI(); 
    syncVisualWorkers(); 
}

document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
